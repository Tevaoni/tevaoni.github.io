<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Arrosage – Amiens</title>
  <style>
    body { text-align: center; }
    h1 { color: #22aa77; }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }
    th, td {
      border: 1px solid #22aa77;
    }
    th { background: #66cc99; }
    .weekend { background-color: #804A80; }
    .controls {
      margin-top: 1em;
      font-size: 0.95em;
    }
    .controls label {
      margin: 0 1em;
    }
  </style>
</head>
<body>
  <h1>💧 Programme d’arrosage</h1>

  <div class="controls">
    <strong>Programme :</strong>
    <label><input type="radio" name="terrain" value="Tout" checked> Tout</label>
    <label><input type="radio" name="terrain" value="A"> A</label>
    <label><input type="radio" name="terrain" value="B"> B</label>
    <label><input type="radio" name="terrain" value="C"> C</label>
    <label><input type="radio" name="terrain" value="D"> D</label>
    <label><input type="radio" name="terrain" value="Hippodrome"> Hippodrome</label>
  </div>

  <table>
    <thead>
      <tr>
        <th>📅<br>Date</th>
        <th>🌡️<br>Min/Max</th>
        <th>🔆<br>ETP</th>
        <th>🌧️<br>Pluie</th>
        <th>💧<br>Besoin</th>
        <th>🧮<br>Programme</th>
      </tr>
    </thead>
    <tbody id="contenu-tableau"></tbody>
  </table>

  <p id="loading">Chargement des données météo...</p>

  <script>
    function styleVariation(valActuelle, valPrecedente, seuil = 0.1) {
      return Math.abs(valActuelle - valPrecedente) > seuil
      ? 'background-color:#ffd862;' 
      : '';
    }
    const programmes = {
      A: { surface: 7300, volume: 9, duree: 24 },
      B: { surface: 8300, volume: 9, duree: 25 },
      C: { surface: 8400, volume: 9, duree: 25 },
      D: { surface: 10000, volume: 11, duree: 24 },
      Hippodrome: { surface: 13000, volume: 16, duree: 40 },
      Tout: { surface: 46900, volume: 54, duree: 136 }
    };

    let donneesPrecedentes = null;
    let meteo = null;

    function afficherColonneProgrammeActive() {
      const terrain = document.querySelector('input[name="terrain"]:checked').value;
      document.querySelectorAll('[class^="programme-cellule-"]').forEach(c => c.style.display = "none");
      document.querySelectorAll('.programme-cellule-' + terrain).forEach(c => c.style.display = "table-cell");
    }

    async function chargerMeteo() {
      try {
        const url = "https://api.open-meteo.com/v1/forecast?latitude=49.8942&longitude=2.2633&daily=temperature_2m_max,temperature_2m_min,et0_fao_evapotranspiration,precipitation_sum&timezone=Europe%2FParis&altitude=22&forecast_days=16";
        const res = await fetch(url);
        const data = await res.json();
        if (!data || !data.daily || !data.daily.time) {
          throw new Error("Données météo incomplètes.");
        }
        meteo = data.daily;
        afficherProgramme();
      } catch (err) {
        document.getElementById("loading").textContent = "Erreur de chargement météo.";
        console.error("❌ Erreur météo :", err);
      }
    }
    
    function afficherProgramme() {
      if (!meteo) return;
      const jours = meteo.time, tMax = meteo.temperature_2m_max, tMin = meteo.temperature_2m_min, etp = meteo.et0_fao_evapotranspiration, pluie = meteo.precipitation_sum;
      const tbody = document.getElementById("contenu-tableau");
      tbody.innerHTML = "";

      
      for (let i = 0; i < jours.length; i++) {
        const dateObj = new Date(jours[i]);
        const isWeekend = [0,6].includes(dateObj.getDay());
        const date = dateObj.toLocaleDateString("fr-FR", { weekday: 'short', day: 'numeric', month: 'short' });
        const tmin = tMin[i], tmax = tMax[i], etpJour = etp[i], pluieJour = pluie[i];
        const besoinNet = Math.max(0, etpJour - pluieJour);

            function calculerBonusPerso(besoinNet) {
      const coeff = besoinNet / 1.2;
      if (coeff > 0 && coeff < 1) {
        return coeff > 0.4 ? 100 : 0;
      }
      return Math.floor(coeff) * 100;
    }
        const bonus = calculerBonusPerso(besoinNet);
        const aucunBesoin = bonus === 0;
        const colonnesProgramme = Object.entries(programmes).map(([nom, p]) => {
          if (aucunBesoin) {
              return `<td class="programme-cellule-${nom}" style="display:none;">🚫<br>Aucun arrosage</td>`;
          }
          const besoin = (besoinNet * p.surface) / 1000;
          const cycles = Math.min(6, Math.ceil(besoin / p.volume));
          const volume = cycles * p.volume;
          const duree = cycles * p.duree;
          const apport = (volume / p.surface) * 1000;
          return `<td class="programme-cellule-${nom}" style="display:none;">
            Temps : ${Math.floor(duree/60)}h${Math.round(duree%60)}min<br>
            Volume : ${volume.toFixed(1)} m³<br>
            Surface : ${p.surface.toLocaleString()} m²<br>
            Apport : ${apport.toFixed(1)} mm
          </td>`;
        }).join('');
const ancienBesoinNet = Math.max(0, donneesPrecedentes.etp[i] - donneesPrecedentes.pluie[i]);
        const fondBesoin = styleVariation(besoinNet, ancienBesoinNet);

        const ligne = `
          <tr>
            <td class="${isWeekend ? 'weekend' : ''}">${date}</td>
            <td>
              <span style="${tmin < 5 ? 'color:blue;font-weight:bold;' : tmin > 30 ? 'color:red;font-weight:bold;' : ''}">${tmin.toFixed(1)}°C</span>
              <br>
              <span style="${tmax < 5 ? 'color:blue;font-weight:bold;' : tmax > 30 ? 'color:red;font-weight:bold;' : ''}">${tmax.toFixed(1)}°C</span>
            </td>
            <td style="${etpJour > 6 ? 'color:red;font-weight:bold;' : ''}">${etpJour.toFixed(1)}mm</td>
            <td style="${pluieJour > 1 ? 'color:blue;font-weight:bold;' : ''}">${pluieJour.toFixed(1)}mm</td>
            <td style="${fondBesoin}">
              ${aucunBesoin ? '🚫' : `${bonus}%
              <br>
              ${besoinNet.toFixed(1)}mm`}
            </td>
            ${colonnesProgramme}
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", ligne);
      }

      document.getElementById("loading").style.display = "none";
      donneesPrecedentes = {
        tmin: [...tMin],
        tmax: [...tMax],
        etp: [...etp],
        pluie: [...pluie]
      };
      afficherColonneProgrammeActive();
    }

    document.querySelectorAll('input[name="terrain"]').forEach(radio => {
      radio.addEventListener("change", afficherColonneProgrammeActive);
    });

    chargerMeteo();
    setInterval(chargerMeteo, 10 * 60 * 1000);
  </script>
</body>
</html>
