<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Arrosage â€“ Amiens</title>
</head>
<body>
  <h1>ğŸ’§ Programme dâ€™arrosage automatique</h1>
  <p>DonnÃ©es mÃ©tÃ©o en direct via <strong>Open-Meteo</strong> :</p>
  <table>
    <tr>
      <th>ğŸ“…<br>Date</th>
      <th>ğŸŒ¡ï¸<br>Min/Max</th>
      <th>ğŸ”†<br>ETP</th>
      <th>ğŸŒ§ï¸<br>Pluie</th>
      <th>ğŸ’§<br>Besoin estimÃ©</th>
      <th>ğŸ”<br>Bonus</th>
      <th>â±ï¸&ğŸ’§<br>Programme A</th>
      <th>â±ï¸&ğŸ’§<br>Programme tout</th>
    </tr>
  </table>
  <p id="loading" style="text-align:center;">Chargement des donnÃ©es mÃ©tÃ©o...</p>
  <script>
    let derniereDate = null;
    let donneesPrecedentes = null;
    const surface = 7500;
    const volumeParCycle = 9;
    const dureeParCycle = 24;

    async function afficherProgramme() {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=49.8942&longitude=2.2633&daily=temperature_2m_max,temperature_2m_min,et0_fao_evapotranspiration,precipitation_sum&&timezone=Europe%2FParis&altitude=22";
      const res = await fetch(url);
      const data = await res.json();

      const nouvelleDate = data.daily?.time?.[0];
      if (nouvelleDate === derniereDate) {
        console.log("â³ DonnÃ©es non mises Ã  jour, attente...");
      return;
      }
      derniereDate = nouvelleDate;
  
      // â¬‡ï¸ ton code existant ici pour actualiser le tableau â¬‡ï¸
      
      if (!data.daily || !data.daily.time) {
        console.error("Erreur dans la rÃ©ponse API :", data);
        return;
      }

      const jours = data.daily.time;
      const tMax = data.daily.temperature_2m_max;
      const tMin = data.daily.temperature_2m_min;
      const etp = data.daily.et0_fao_evapotranspiration;
      const pluie = data.daily.precipitation_sum;

      // âœ… VÃ©rifie que les donnÃ©es sont bien structurÃ©es avant dâ€™avancer
      if (!data.daily || !data.daily.time) {
        console.error("Erreur dans la rÃ©ponse API :", data);
        return;
      }
      const table = document.querySelector("table");
      table.innerHTML = `
        <tr>
          <th>ğŸ“…<br>Date</th>
          <th>ğŸŒ¡ï¸<br>Min/Max</th>
          <th>ğŸ”†<br>ETP</th>
          <th>ğŸŒ§ï¸<br>Pluie</th>
          <th>ğŸ’§<br>Besoin estimÃ©</th>
          <th>ğŸ”<br>Bonus</th>
          <th>â±ï¸&ğŸ’§<br>Programme A</th>
          <th>â±ï¸&ğŸ’§<br>Programme tout</th>
        </tr>
      `;
      for (let i = 0; i < 7; i++) {
        const date = new Date(jours[i]).toLocaleDateString("fr-FR", { weekday: 'short', day: 'numeric', month: 'short' });
        const tmax = tMax[i];
        const tmin = tMin[i];
        const etpJour = etp[i];
        const besoin = (etpJour * surface) / 1000;
        const cycles = Math.min(6, Math.ceil(besoin / volumeParCycle));
        const volumeTotal = cycles * volumeParCycle;
        const temps = cycles * dureeParCycle;
        // pour le programme tout
        const volume6Terrains = volumeTotal * 6;
        const temps6Terrains = temps * 5.66;
        const heures6T = Math.floor(temps6Terrains / 60);
        const minutes6T = Math.round(temps6Terrains % 60);
        // ajoute la prÃ©cipitation
        const pluieJour = pluie[i];
        const pluieColor = pluieJour > 0 ? 'style="color:blue;font-weight:bold;"' : '';
        const couleurTmin = tmin > 30 ? 'style="color:red;font-weight:bold;"' : '';
        const couleurTmax = tmax > 30 ? 'style="color:red;font-weight:bold;"' : '';
        const couleurETP = etpJour > 6 ? 'style="color:red;font-weight:bold;"' : '';
        
        let changementTmin = '', changementTmax = '', changementETP = '', changementPluie = '';
        
        if (donneesPrecedentes) {
          if (tmin !== donneesPrecedentes.tmin[i]) changementTmin = 'style="background-color:#1e602c;"';
          if (tmax !== donneesPrecedentes.tmax[i]) changementTmax = 'style="background-color:#1e602c;"';
          if (etpJour !== donneesPrecedentes.etp[i]) changementETP = 'style="background-color:#1e602c;"';
          if (pluieJour !== donneesPrecedentes.pluie[i]) changementPluie = 'style="background-color:#1e602c;"';
        }
        
        const ligne = `
          <tr>
            <td>${date}</td>
            <td><span ${changementTmin} ${couleurTmin}>${tmin.toFixed(1)}Â°</span><br><span ${changementTmax} ${couleurTmax}>${tmax.toFixed(1)}Â°</span></td>
            <td ${changementETP} ${couleurETP}>${etpJour.toFixed(1)}mm</td>
            <td ${changementPluie} ${pluieColor}>${pluieJour.toFixed(1)}mm</td>
            <td>${besoin.toFixed(1)}mÂ³</td>
            <td>${cycles * 100}%</td>
            <td>${volumeTotal}mÂ³<br>${Math.floor(temps/60)}h${temps%60}min</td>
            <td>${volume6Terrains.toFixed(1)}mÂ³<br>${heures6T}h${minutes6T}min</td>
          </tr>
        `;
        table.insertAdjacentHTML("beforeend", ligne);
      }
      // âœ… Masquer le message de chargement une fois les donnÃ©es affichÃ©es
      document.getElementById("loading").style.display = "none";
      donneesPrecedentes = {
      tmin: [...tMin],
      tmax: [...tMax],
      etp: [...etp],
      pluie: [...pluie]
      };
    }

    afficherProgramme();
    // â±ï¸ RafraÃ®chir automatiquement toutes les 3 heures (3 Ã— 60 Ã— 60 Ã— 1000 ms)
    setInterval(afficherProgramme, 10 * 60 * 1000);
  </script>
</body>
</html>
