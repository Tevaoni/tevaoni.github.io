<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Arrosage – Amiens</title>
  <style>
    body {
      text-align: center;
      margin: 0;
      padding: 1em;
    }
    h1 {
      color: #22aa77;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin: 1em auto;
    }
    th, td {
      font-size: 0.9em;
      padding: 0.7em;
      border: 1px solid #22aa77;
    }
    th {
      background: #66cc99;
    }
    .weekend {
      background-color: #804A80;
    }
    .controls {
      margin-top: 1em;
      font-size: 0.95em;
    }
    .controls label {
      margin: 0 1em;
    }
  </style>
</head>
<body>
  <h1>💧 Programme d’arrosage</h1>

  <div class="controls">
    <strong>Programme :</strong>
    <label><input type="radio" name="terrain" value="A" checked> A</label>
    <label><input type="radio" name="terrain" value="B"> B</label>
    <label><input type="radio" name="terrain" value="C"> C</label>
    <label><input type="radio" name="terrain" value="D"> D</label>
    <label><input type="radio" name="terrain" value="Hippodrome"> Hippodrome</label>
    <label><input type="radio" name="terrain" value="Tout"> Tout</label>
  </div>

  <table>
    <thead>
      <tr>
        <th>📅<br>Date</th>
        <th>🌡️<br>Min/Max</th>
        <th>🔆<br>ETP</th>
        <th>🌧️<br>Pluie</th>
        <th>💧<br>Besoin</th>
        <th>📋<br>Programme</th>
      </tr>
    </thead>
    <tbody id="contenu-tableau"></tbody>
  </table>

  <p id="loading">Chargement des données météo...</p>

  <script>
    let derniereDate = null;
    let donneesPrecedentes = null;
    const programmes = {
      A: { surface: 7300, volume: 9, duree: 24 },
      B: { surface: 8300, volume: 9, duree: 25 },
      C: { surface: 8400, volume: 9, duree: 25 },
      D: { surface: 10000, volume: 11, duree: 24 },
      Hippodrome: { surface: 13000, volume: 16, duree: 40 },
      Tout: { surface: 46900, volume: 54, duree: 136 } // soit 2h16
    };

    function getProgrammeActif() {
      return document.querySelector('input[name="terrain"]:checked').value;
    }

    async function afficherProgramme() {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=49.8942&longitude=2.2633&daily=temperature_2m_max,temperature_2m_min,et0_fao_evapotranspiration,precipitation_sum&timezone=Europe%2FParis&altitude=22&forecast_days=16";
      const res = await fetch(url);
      const data = await res.json();

      const nouvelleDate = data.daily?.time?.[0];
      if (nouvelleDate === derniereDate) {
        console.log("⏳ Données non mises à jour");
        return;
      }
      derniereDate = nouvelleDate;

      const jours = data.daily.time;
      const tMax = data.daily.temperature_2m_max;
      const tMin = data.daily.temperature_2m_min;
      const etp = data.daily.et0_fao_evapotranspiration;
      const pluie = data.daily.precipitation_sum;

      const tbody = document.getElementById("contenu-tableau");
      tbody.innerHTML = "";

      const terrain = getProgrammeActif();
      const { surface, volume, duree } = programmes[terrain];

      for (let i = 0; i < jours.length; i++) {
        const dateObj = new Date(jours[i]);
        const date = dateObj.toLocaleDateString("fr-FR", { weekday: 'short', day: 'numeric', month: 'short' });
        const jourSemaine = dateObj.getDay();
        const isWeekend = jourSemaine === 0 || jourSemaine === 6;

        const tmin = tMin[i];
        const tmax = tMax[i];
        const etpJour = etp[i];
        const pluieJour = pluie[i];
        const besoinNet = Math.max(0, etpJour - pluieJour);
        const cycles = Math.min(6, Math.ceil((besoinNet * surface) / (volume * 1000)));
        const bonusPourcent = cycles * 100;

        const volumeApplique = (volume * cycles);
        const dureeApplique = duree * cycles;
        const apportMM = (volumeApplique / surface) * 1000;

        const ligne = `
          <tr class="${isWeekend ? 'weekend' : ''}">
            <td>${date}</td>
            <td>${tmin.toFixed(1)}°C<br>${tmax.toFixed(1)}°C</td>
            <td>${etpJour.toFixed(1)}mm</td>
            <td>${pluieJour.toFixed(1)}mm</td>
            <td>${besoinNet.toFixed(1)}mm<br>${bonusPourcent}%</td>
            <td>
              Temps : ${Math.floor(dureeApplique / 60)}h${Math.round(dureeApplique % 60)}min<br>
              Volume : ${volumeApplique.toFixed(1)} m³<br>
              Surface : ${surface.toLocaleString()} m²<br>
              Apport : ${apportMM.toFixed(1)} mm
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", ligne);
      }

      document.getElementById("loading").style.display = "none";
      donneesPrecedentes = {
        tmin: [...tMin],
        tmax: [...tMax],
        etp: [...etp],
        pluie: [...pluie]
      };
    }

    // Recalculer à chaque sélection de programme
    document.querySelectorAll('input[name="terrain"]').forEach(radio => {
      radio.addEventListener("change", afficherProgramme);
    });

    afficherProgramme();
    setInterval(afficherProgramme, 10 * 60 * 1000);
  </script>
</body>
</html>
