<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <title>Arrosage – Amiens</title>
  <style>
    body { font-family: 'Inter', sans-serif; padding: 2em; max-width: 900px; margin: auto; background: #f9f9f9; }
    h1 { color: #2a7; text-align: center;}
    table { width: 100%; border-collapse: collapse; margin-top: 1em; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;}
    th, td { padding: 0.7em; border: 1px solid #ccc; text-align: center; }
    th { background: #e8f5e9; }
    tr:nth-child(even) { background-color: #f1f1f1; }
    p { text-align:center; color: #555; }
  </style>
</head>
<body>
  <h1>💧 Programme d’arrosage automatique</h1>
  <p>Données météo en direct via <strong>Open-Meteo</strong> : <button onclick="afficherProgramme()" style="margin: 1em auto; display: block;">🔄 Rafraîchir</button></p>

  <table id="tableau">
    <tr>
      <th>📅<br>Date</th>
      <th>🌡️<br>Min/Max</th>
      <th>🌧️<br>Pluie</th>
      <th>🔆<br>ETP</th>
      <th>💧<br>Besoin estimé</th>
      <th>🔁<br>Bonus</th>
      <th>⏱️&💧<br>Programme A</th>
      <th>⏱️&💧<br>Programme tout</th>
    </tr>
  </table>
  <p id="loading" style="text-align:center;">Chargement des données météo...</p>
  <script>
    const surface = 7500;
    const volumeParCycle = 9;
    const dureeParCycle = 24;

    async function afficherProgramme() {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=49.8942&longitude=2.2633&daily=temperature_2m_max,temperature_2m_min,et0_fao_evapotranspiration,precipitation_sum&&timezone=Europe%2FParis&altitude=22";
      const res = await fetch(url);
      const data = await res.json();
      
    // ✅ Vérifie que les données sont bien structurées avant d’avancer
    if (!data.daily || !data.daily.time) {
      console.error("Erreur dans la réponse API :", data);
      return;
    }

      const jours = data.daily.time;
      const tMax = data.daily.temperature_2m_max;
      const tMin = data.daily.temperature_2m_min;
      const etp = data.daily.et0_fao_evapotranspiration;
      const pluie = data.daily.precipitation_sum;

      const table = document.getElementById("tableau");

      for (let i = 0; i < 7; i++) {
        const date = new Date(jours[i]).toLocaleDateString("fr-FR", { weekday: 'short', day: 'numeric', month: 'short' });
        const tmax = tMax[i];
        const tmin = tMin[i];
        const etpJour = etp[i];
        const besoin = (etpJour * surface) / 1000;
        const cycles = Math.min(6, Math.ceil(besoin / volumeParCycle));
        const volumeTotal = cycles * volumeParCycle;
        const temps = cycles * dureeParCycle;
        // pour le programme tout
        const volume6Terrains = volumeTotal * 6;
        const temps6Terrains = temps * 5.66;
        const heures6T = Math.floor(temps6Terrains / 60);
        const minutes6T = Math.round(temps6Terrains % 60);
        // ajoute la précipitation
        const pluieJour = pluie[i];
        const pluieColor = pluieJour > 0 ? 'style="color:blue;font-weight:bold;"' : '';
        const couleurTmin = tmin > 30 ? 'style="color:red;font-weight:bold;"' : '';
        const couleurTmax = tmax > 30 ? 'style="color:red;font-weight:bold;"' : '';
        const couleurETP = etpJour > 6 ? 'style="color:red;font-weight:bold;"' : '';

        const ligne = `
          <tr>
            <td>${date}</td>
            <td><span ${couleurTmin}>${tmin.toFixed(1)}°</span> / <span ${couleurTmax}>${tmax.toFixed(1)}°</span></td>
            <td ${pluieColor}>${pluieJour.toFixed(1)}mm</td>
            <td><span ${couleurETP}>${etpJour.toFixed(1)}mm</span></td>
            <td>${besoin.toFixed(1)}m³</td>
            <td>${cycles * 100}%</td>
            <td>${volumeTotal}m³<br>${Math.floor(temps/60)}h${temps%60}min</td>
            <td>${volume6Terrains.toFixed(1)}m³<br>${heures6T}h${minutes6T}min</td>
          </tr>
        `;
        table.insertAdjacentHTML("beforeend", ligne);
      }
      // ✅ Masquer le message de chargement une fois les données affichées
      document.getElementById("loading").style.display = "none";
    }

    afficherProgramme();
  </script>
</body>
</html>
